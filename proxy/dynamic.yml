# HTTP routers, services, and middlewares
http:
  middlewares:
    # Rate limiter (per IP address)
    ratelimiter:
      rateLimit:
        average: 80
        burst: 100
        period: 1s

    # In flight request limiter (total number of requests in flight at a time)
    inflightlimiter:
      inFlightReq:
        amount: 2000

    # Compress responses
    responseCompressor:
      compress:
        includedContentTypes:
          - text/plain
          - text/html
          - text/xml
          - text/css
          - text/javascript
          - application/javascript
          - application/x-javascript
          - application/xml
          - application/xml+rss
          - image/svg+xml
          - image/x-icon

    # Docker Dashboard CSRF fix
    # more details: https://www.portainer.io/blog/origin-invalid-errors-with-portainer-2.27.7-behind-reverse-proxies
    dockerdashboard-csrf:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"

    # Proxy Dashboard authentication
    proxydashboard-auth:
      basicAuth:
        users: # to generate: htpasswd -nb -B username password
          - "admin:$2y$05$KPBbjG5.546zDPpw3QnXBObvD68.hBYMshkwCHOGvujrupmPuA1BO"

  routers:

    # Backend subdomain
    backend:
      rule: HostRegexp(`^backend\.[a-z0-9\_\-]+\.[a-z]+$`)
      entryPoints:
        - webservice
      service: app-service

    # Docker Dashboard subdomain
    dockerdashboard:
      rule: HostRegexp(`^dockerdashboard\.[a-z0-9\_\-]+\.[a-z]+$`)
      entryPoints:
        - webservice
      service: docker-dashboard-service
      middlewares:
        - dockerdashboard-csrf

    # MongoDB Dashboard subdomain
    mongodashboard:
      rule: HostRegexp(`^mongodashboard\.[a-z0-9\_\-]+\.[a-z]+$`)
      entryPoints:
        - webservice
      service: mongodb-dashboard-service

    # Proxy Dashboard subdomain
    proxydashboard:
      rule: HostRegexp(`^proxydashboard\.[a-z0-9\_\-]+\.[a-z]+$`)
      entryPoints:
        - webservice
      service: api@internal
      middlewares:
        - proxydashboard-auth

    # Main domain
    main-domain:
      rule: HostRegexp(`^[a-z0-9\_\-]+\.[a-z]+$`)
      entryPoints:
        - webservice
      service: frontend-service

    # Proxy healthcheck
    healthcheck:
      rule: Path(`/healthcheck`)
      entryPoints:
        - webservice
      service: ping@internal

  services:
    frontend-service:
      loadBalancer:
        servers:
          - url: "http://frontend:3000"

    app-service:
      loadBalancer:
        servers:
          - url: "http://app:80"

    docker-dashboard-service:
      loadBalancer:
        servers:
          - url: "http://docker_dashboard:9000"

    mongodb-dashboard-service:
      loadBalancer:
        servers:
          - url: "http://mongodb_dashboard:8081"
